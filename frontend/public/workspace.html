<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace - SmartWrite</title>
    <link rel="stylesheet" href="/assets/styles/style.css">
    <link rel="stylesheet" href="/assets/styles/workspace.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <style>
        /* Ensure modal is visible when active */
        .modal-overlay.active {
            display: flex !important;
        }
    </style>
</head>
<body class="workspace">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="settings-button" id="sidebarSettingsBtn" onclick="directOpenModal('settingsModal')">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        <div class="file-tree">
            <div class="file-tree-header">
                <div class="file-tree-actions">
                    <button class="action-btn" title="New note">
                        <i class="fas fa-file"></i>
                    </button>
                    <button class="action-btn" title="New folder">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="action-btn" title="Sort files">
                        <i class="fas fa-sort"></i>
                    </button>
                </div>
            </div>
            <div class="file-tree-content" id="fileTree">
                <!-- File tree will be dynamically populated here -->
            </div>
            <!-- Sort menu dropdown -->
            <div class="sort-menu" id="sortMenu">
                <div class="sort-menu-item" onclick="sortFiles('name')">
                    <i class="fas fa-sort-alpha-down"></i>
                    <span>Sort by name</span>
                </div>
                <div class="sort-menu-item" onclick="sortFiles('modified')">
                    <i class="fas fa-clock"></i>
                    <span>Sort by modified</span>
                </div>
                <div class="sort-menu-item" onclick="sortFiles('created')">
                    <i class="fas fa-calendar"></i>
                    <span>Sort by created</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- PDF Viewer Section -->
        <div class="pdf-section">
            <!-- PDF Controls -->
            <div class="pdf-controls">
                <div class="zoom-control">
                    <button class="zoom-btn" id="zoomOut">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="pdf-viewer" id="pdfViewer"></div>
            <div class="pdf-file-bar">
                <div class="pdf-files" id="pdfFiles">
                    <!-- PDF file tabs will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                    Hello! I'm here to help you analyze your documents. What would you like to know?
                </div>
            </div>
        </div>
        <div class="chat-input-container">
            <textarea 
                id="chatInput" 
                placeholder="Type your message here..."
                rows="1"
                oninput="this.style.height='0px'; this.style.height = Math.max(42, Math.min(this.scrollHeight, 150)) + 'px';"
                onkeyup="this.style.height='0px'; this.style.height = Math.max(42, Math.min(this.scrollHeight, 150)) + 'px';"
            ></textarea>
            <button id="sendMessage">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="directCloseModal('settingsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="settings-wrapper">
                    <div class="settings-sidebar">
                        <ul>
                            <li data-setting="appearance" class="active">
                                <i class="fas fa-palette"></i>
                                Appearance
                            </li>
                            <li data-setting="editor">
                                <i class="fas fa-edit"></i>
                                Editor
                            </li>
                            <li data-setting="pdf-viewer">
                                <i class="fas fa-file-pdf"></i>
                                PDF Viewer
                            </li>
                            <li data-setting="about">
                                <i class="fas fa-info-circle"></i>
                                About
                            </li>
                        </ul>
                    </div>
                    <div class="settings-content">
                        <!-- Appearance Panel -->
                        <div id="appearance-panel" class="settings-panel">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Theme</div>
                                    <div class="settings-item-description">Choose between light and dark theme</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="themeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Font Size</div>
                                    <div class="settings-item-description">Adjust the base font size for the application</div>
                                </div>
                                <select class="settings-select" id="fontSize">
                                    <option value="12">12px</option>
                                    <option value="14" selected>14px</option>
                                    <option value="16">16px</option>
                                    <option value="18">18px</option>
                                </select>
                            </div>
                        </div>

                        <!-- Editor Panel -->
                        <div id="editor-panel" class="settings-panel" style="display: none;">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Auto Save</div>
                                    <div class="settings-item-description">Automatically save changes as you type</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoSave" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Spell Check</div>
                                    <div class="settings-item-description">Enable spell checking in the editor</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="spellCheck">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Disable Popups</div>
                                    <div class="settings-item-description">Disable confirmation dialogs when deleting or renaming items</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="disablePopups">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- PDF Viewer Panel -->
                        <div id="pdf-viewer-panel" class="settings-panel" style="display: none;">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Default Zoom Level</div>
                                    <div class="settings-item-description">Set the default zoom level for PDFs</div>
                                </div>
                                <select class="settings-select" id="defaultZoom">
                                    <option value="0.5">50%</option>
                                    <option value="0.75">75%</option>
                                    <option value="1" selected>100%</option>
                                    <option value="1.25">125%</option>
                                    <option value="1.5">150%</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Smooth Scrolling</div>
                                    <div class="settings-item-description">Enable smooth scrolling in PDF viewer</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="smoothScroll" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- About Panel -->
                        <div id="about-panel" class="settings-panel" style="display: none;">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Version</div>
                                    <div class="settings-item-description">1.0.0</div>
                                </div>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Created By</div>
                                    <div class="settings-item-description">Your Team Name</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Note Modal -->
    <div id="newNoteModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 class="modal-title">New Note</h2>
                <button class="modal-close" onclick="directCloseModal('newNoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newNoteForm" onsubmit="event.preventDefault(); createNewNote();">
                    <div class="form-group">
                        <label for="noteName" class="form-label">Note Name</label>
                        <input type="text" id="noteName" class="form-input" placeholder="Enter note name" required>
                    </div>
                    <div class="form-group">
                        <label for="noteDescription" class="form-label">Description</label>
                        <textarea id="noteDescription" class="form-input" rows="3" placeholder="Enter note description"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attachments</label>
                        <div class="drop-zone">
                            <input type="file" id="noteFiles" multiple accept=".pdf,.doc,.docx,.txt,image/*" style="display: none;">
                            <div class="drop-zone-text">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Drop files here or click to upload</span>
                                <span class="small">Supports PDF, images, and documents</span>
                            </div>
                        </div>
                        <div class="file-list">
                            <ul id="selectedNoteFiles"></ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="directCloseModal('newNoteModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="createNewNote()">Create Note</button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="newFolderModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 class="modal-title">New Folder</h2>
                <button class="modal-close" onclick="directCloseModal('newFolderModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newFolderForm" onsubmit="event.preventDefault(); createNewFolder();">
                    <div class="form-group">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input type="text" id="folderName" class="form-input" placeholder="Enter folder name" required>
                    </div>
                    <div class="form-group">
                        <label for="folderDescription" class="form-label">Description</label>
                        <textarea id="folderDescription" class="form-input" rows="3" placeholder="Enter folder description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="directCloseModal('newFolderModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="createNewFolder()">Create Folder</button>
            </div>
        </div>
    </div>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    
    <!-- Use type="module" to enable ES6 module imports -->
    <script type="module" src="/frontend/src/js/main.js"></script>
    
    <!-- Fallback script for direct modal control -->
    <script>
        // Direct modal control functions
        function directOpenModal(modalId) {
            console.log('Direct open modal called for: ' + modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                console.error('Modal not found: ' + modalId);
            }
        }
        
        function directCloseModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // If closing the settings modal, save all settings
                if (modalId === 'settingsModal') {
                    saveAllSettings(false); // Pass false to not close the modal again (would cause infinite loop)
                }
                
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Initialize settings tabs
        function initSettingsTabs() {
            console.log('Initializing settings tabs');
            const settingsTabs = document.querySelectorAll('.settings-sidebar li');
            
            if (settingsTabs.length > 0) {
                console.log(`Found ${settingsTabs.length} settings tabs`);
                
                // Add click event to each tab
                settingsTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        console.log(`Tab clicked: ${this.getAttribute('data-setting')}`);
                        
                        // Remove active class from all tabs
                        settingsTabs.forEach(t => t.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Hide all panels
                        document.querySelectorAll('.settings-panel').forEach(panel => {
                            panel.style.display = 'none';
                        });
                        
                        // Show the selected panel
                        const panelId = this.getAttribute('data-setting') + '-panel';
                        const panel = document.getElementById(panelId);
                        if (panel) {
                            console.log(`Showing panel: ${panelId}`);
                            panel.style.display = 'block';
                        } else {
                            console.error(`Panel not found: ${panelId}`);
                        }
                    });
                });
                
                // Initialize with the first tab active
                const activeTab = document.querySelector('.settings-sidebar li.active') || settingsTabs[0];
                if (activeTab) {
                    console.log(`Setting initial active tab: ${activeTab.getAttribute('data-setting')}`);
                    const panelId = activeTab.getAttribute('data-setting') + '-panel';
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.style.display = 'block';
                    }
                }
            } else {
                console.error('No settings tabs found');
            }
        }
        
        // Load saved settings
        function loadSettings() {
            console.log('Loading saved settings');
            
            // Load theme setting
            const savedTheme = localStorage.getItem('darkMode');
            const themeToggle = document.getElementById('themeToggle');
            if (savedTheme !== null && themeToggle) {
                themeToggle.checked = savedTheme === 'true';
                document.documentElement.setAttribute('data-theme', themeToggle.checked ? 'dark' : 'light');
            }
            
            // Load zoom setting
            const savedZoom = localStorage.getItem('defaultZoom');
            const defaultZoom = document.getElementById('defaultZoom');
            if (savedZoom !== null && defaultZoom) {
                defaultZoom.value = savedZoom;
            }
            
            // Load other settings
            const savedAutoSave = localStorage.getItem('autoSave');
            const autoSave = document.getElementById('autoSave');
            if (savedAutoSave !== null && autoSave) {
                autoSave.checked = savedAutoSave === 'true';
            }
            
            const savedSpellCheck = localStorage.getItem('spellCheck');
            const spellCheck = document.getElementById('spellCheck');
            if (savedSpellCheck !== null && spellCheck) {
                spellCheck.checked = savedSpellCheck === 'true';
            }
            
            const savedDisablePopups = localStorage.getItem('disablePopups');
            const disablePopups = document.getElementById('disablePopups');
            if (savedDisablePopups !== null && disablePopups) {
                disablePopups.checked = savedDisablePopups === 'true';
            }
            
            const savedSmoothScroll = localStorage.getItem('smoothScroll');
            const smoothScroll = document.getElementById('smoothScroll');
            if (savedSmoothScroll !== null && smoothScroll) {
                smoothScroll.checked = savedSmoothScroll === 'true';
            }
            
            const savedFontSize = localStorage.getItem('fontSize');
            const fontSize = document.getElementById('fontSize');
            if (savedFontSize !== null && fontSize) {
                fontSize.value = savedFontSize;
            }
        }
        
        // Save settings
        function saveAllSettings(shouldCloseModal = true) {
            console.log('Saving all settings');
            
            // Save theme setting
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                localStorage.setItem('darkMode', themeToggle.checked);
                document.documentElement.setAttribute('data-theme', themeToggle.checked ? 'dark' : 'light');
            }
            
            // Save zoom setting
            const defaultZoom = document.getElementById('defaultZoom');
            if (defaultZoom) {
                localStorage.setItem('defaultZoom', defaultZoom.value);
            }
            
            // Save other settings
            const autoSave = document.getElementById('autoSave');
            if (autoSave) {
                localStorage.setItem('autoSave', autoSave.checked);
            }
            
            const spellCheck = document.getElementById('spellCheck');
            if (spellCheck) {
                localStorage.setItem('spellCheck', spellCheck.checked);
            }
            
            const disablePopups = document.getElementById('disablePopups');
            if (disablePopups) {
                localStorage.setItem('disablePopups', disablePopups.checked);
            }
            
            const smoothScroll = document.getElementById('smoothScroll');
            if (smoothScroll) {
                localStorage.setItem('smoothScroll', smoothScroll.checked);
            }
            
            const fontSize = document.getElementById('fontSize');
            if (fontSize) {
                localStorage.setItem('fontSize', fontSize.value);
                document.documentElement.style.fontSize = fontSize.value + 'px';
            }
            
            // Close the modal if requested
            if (shouldCloseModal) {
                directCloseModal('settingsModal');
            }
        }
        
        // Add event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Direct script loaded');
            
            // Add click handler to settings button
            const settingsBtn = document.getElementById('sidebarSettingsBtn');
            if (settingsBtn) {
                console.log('Settings button found in direct script');
                settingsBtn.onclick = function() {
                    console.log('Settings button clicked in direct script');
                    directOpenModal('settingsModal');
                    // Initialize tabs when modal is opened
                    initSettingsTabs();
                    // Load saved settings
                    loadSettings();
                    return false;
                };
            }
            
            // Add click handlers to close buttons
            const closeButtons = document.querySelectorAll('.modal-close');
            closeButtons.forEach(function(btn) {
                btn.onclick = function() {
                    const modalId = this.closest('.modal-overlay').id;
                    directCloseModal(modalId);
                    return false;
                };
            });
            
            // Add event listeners for settings changes
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('change', function() {
                    document.documentElement.setAttribute('data-theme', this.checked ? 'dark' : 'light');
                });
            }
            
            const fontSize = document.getElementById('fontSize');
            if (fontSize) {
                fontSize.addEventListener('change', function() {
                    document.documentElement.style.fontSize = this.value + 'px';
                });
            }
            
            // Add click handler to modal overlay for closing when clicking outside
            const modalOverlays = document.querySelectorAll('.modal-overlay');
            modalOverlays.forEach(function(overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        directCloseModal(this.id);
                    }
                });
            });
        });
    </script>
</body>
</html> 