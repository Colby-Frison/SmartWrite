<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace - SmartWrite</title>
    <link rel="stylesheet" href="/assets/styles/style.css">
    <link rel="stylesheet" href="/assets/styles/workspace.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script>
        // Set up PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            console.log('[PDF.js] Worker initialized');
        } else {
            console.error('[PDF.js] PDF.js library not loaded');
        }
        
        // Add error handler for PDF.js
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('pdf.js')) {
                console.error('[PDF.js Error]', event.message, 'at', event.filename, 'line', event.lineno);
            }
        });
        
        // Test PDF.js availability
        console.log('[PDF.js] Library loaded, version:', pdfjsLib ? pdfjsLib.version : 'not available');
    </script>
    <style>
        /* Ensure modal is visible when active */
        .modal-overlay.active {
            display: flex !important;
        }
        
        /* PDF Viewer Styles */
        .pdf-section {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pdf-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--bg-primary);
            position: relative;
            overflow: hidden; /* Prevent double scrollbars */
        }

        .pdf-container {
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: var(--bg-primary);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 0; /* Allow container to shrink */
            height: 100%;
        }
        
        .pdf-page {
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            background-color: var(--pdf-bg);
            border-radius: 4px;
            overflow: hidden;
            will-change: transform;
            flex-shrink: 0; /* Prevent page from shrinking */
        }
        
        .pdf-page-wrapper {
            position: relative;
            margin: 0 auto;
            transform-origin: top left;
            will-change: transform;
            flex-shrink: 0; /* Prevent wrapper from shrinking */
            -webkit-font-smoothing: subpixel-antialiased;
            text-rendering: optimizeLegibility;
        }
        
        .pdf-page canvas {
            display: block;
            margin: 0 auto;
            user-select: none;
            flex-shrink: 0; /* Prevent canvas from shrinking */
        }
        
        .page-number {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .page-number:hover {
            transform: scale(1.05);
            background-color: var(--accent-primary);
            color: white;
        }
        
        .page-number:active {
            transform: scale(0.95);
        }
        
        .pdf-error {
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin: 20px;
            background-color: rgba(211, 47, 47, 0.1);
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }
        
        #pdfPagesContainer {
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Text Layer Styles */
        .textLayer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: left top;
            border: none;
            padding: 0;
            margin: 0;
            pointer-events: auto;
            user-select: text;
            -webkit-font-smoothing: subpixel-antialiased;
            text-rendering: optimizeLegibility;
            /* Basic text properties */
            font-size: normal;
            line-height: normal;
            /* Prevent any stretching */
            display: inline-block;
            width: fit-content !important;
            height: auto !important;
            /* Ensure proper text boundaries */
            white-space: pre;
            overflow: visible;
        }

        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.8;
            line-height: 1.0;
            pointer-events: auto;
            user-select: text;
            cursor: text;
            z-index: 2;
            /* Ensure proper text rendering */
            mix-blend-mode: multiply;
            transform-origin: 0 0;
        }

        /* Much more visible selection styles */
        .textLayer ::selection {
            background: rgba(73, 169, 255, 0.8) !important; /* Bright blue with high opacity */
            mix-blend-mode: multiply;
            color: transparent;
        }

        .textLayer ::-moz-selection {
            background: rgba(73, 169, 255, 0.8) !important;
            mix-blend-mode: multiply;
            color: transparent;
        }

        .textLayer span::selection {
            background: rgba(73, 169, 255, 0.8) !important;
            mix-blend-mode: multiply;
            color: transparent;
        }

        .textLayer span::-moz-selection {
            background: rgba(73, 169, 255, 0.8) !important;
            mix-blend-mode: multiply;
            color: transparent;
        }

        /* Add a subtle outline to selected text */
        .textLayer span.selected {
            box-shadow: 0 0 0 1px rgba(73, 169, 255, 0.5);
        }

        /* Ensure PDF background doesn't interfere with selection */
        .pdf-page {
            background-color: white;
            mix-blend-mode: normal;
        }

        .pdf-page canvas {
            mix-blend-mode: normal;
        }

        /* Search Highlight Styles */
        .search-highlight {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.3);
            border: 1px solid rgba(255, 255, 0, 0.5);
            pointer-events: none;
            z-index: 3;
            mix-blend-mode: multiply;
        }

        .search-highlight:hover {
            background-color: rgba(255, 255, 0, 0.5);
        }

        .search-highlight.current {
            background-color: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.8);
            box-shadow: 0 0 3px rgba(76, 175, 80, 0.5);
        }

        /* Loading and Error States */
        .pdf-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        /* PDF Controls */
        .pdf-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 6px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            height: 32px;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-btn {
            padding: 3px 8px;
            border: none;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 12px;
        }

        .zoom-btn:hover {
            background-color: var(--accent-primary);
        }

        .zoom-level {
            min-width: 50px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Search Controls - Updated */
        .search-icon {
            padding: 2px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: color 0.2s ease;
        }

        .search-icon:hover {
            color: var(--accent-primary);
        }

        .search-modal {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 4px;
            display: none;
            z-index: 9999;
            width: 70%;
            max-width: 700px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translateX(-50%) translateY(-20px);
        }

        .search-modal.active {
            display: block !important;
            opacity: 0.9 !important;
            visibility: visible !important;
            transform: translateX(-50%) translateY(0);
            animation: bounceDown 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes bounceDown {
            0% {
                transform: translateX(-50%) translateY(-20px);
            }
            70% {
                transform: translateX(-50%) translateY(5px);
            }
            100% {
                transform: translateX(-50%) translateY(0);
            }
        }

        .search-modal:not(.active) {
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            0% {
                transform: translateX(-50%) translateY(0);
                opacity: 0.9;
            }
            20% {
                transform: translateX(-50%) translateY(10px);
                opacity: 0.9;
            }
            100% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
        }

        .search-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-modal-header span {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .search-modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 2px;
            font-size: 12px;
            transition: color 0.2s ease;
            margin-left: 4px;
        }

        .search-modal-close:hover {
            color: var(--accent-primary);
        }

        .search-modal-content {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 3px 6px;
            min-height: 32px;
        }

        .search-input-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            min-height: 24px;
            opacity: 0.95;
            margin-top: 2px;
        }

        .search-input-group i {
            font-size: 12px;
            opacity: 1;
            color: var(--text-secondary);
        }

        .search-input {
            flex: 1;
            border: none;
            background: none;
            color: var(--text-primary);
            padding: 2px 4px;
            font-size: 13px;
            outline: none;
            width: 100%;
            line-height: 1.2;
        }

        .search-navigation {
            display: flex;
            align-items: center;
            gap: 2px;
            border-left: 1px solid var(--border-color);
            padding-left: 4px;
        }

        .search-count {
            color: var(--text-secondary);
            font-size: 12px;
            min-width: 60px;
            text-align: center;
        }

        .search-nav-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 1px 4px;
            font-size: 12px;
            transition: color 0.2s ease;
        }

        .search-nav-btn:hover:not(:disabled) {
            color: var(--accent-primary);
        }

        .search-nav-btn:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Current Page Indicator */
        .pdf-page.current-page {
            border: 2px solid var(--accent-primary);
        }
    </style>
</head>
<body class="workspace">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="settings-button" id="sidebarSettingsBtn" onclick="directOpenModal('settingsModal')">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        <div class="file-tree">
            <div class="file-tree-header">
                <div class="file-tree-actions">
                    <button class="action-btn" title="New note">
                        <i class="fas fa-file"></i>
                    </button>
                    <button class="action-btn" title="New folder">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="action-btn" title="Sort files">
                        <i class="fas fa-sort"></i>
                    </button>
                </div>
            </div>
            <div class="file-tree-content" id="fileTree">
                <!-- File tree will be dynamically populated here -->
            </div>
            <!-- Sort menu dropdown -->
            <div class="sort-menu" id="sortMenu">
                <div class="sort-menu-item" onclick="sortFiles('name')">
                    <i class="fas fa-sort-alpha-down"></i>
                    <span>Sort by name</span>
                </div>
                <div class="sort-menu-item" onclick="sortFiles('modified')">
                    <i class="fas fa-clock"></i>
                    <span>Sort by modified</span>
                </div>
                <div class="sort-menu-item" onclick="sortFiles('created')">
                    <i class="fas fa-calendar"></i>
                    <span>Sort by created</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- PDF Viewer Section -->
        <div class="pdf-section">
            <!-- PDF Controls - Updated -->
            <div class="pdf-controls">
                <div class="zoom-control">
                    <button class="zoom-btn" id="zoomOut">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <button class="search-icon" id="searchIcon">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="pdf-viewer" id="pdfViewer">
                <!-- Search Modal - Moved inside PDF viewer -->
                <div id="searchModal" class="search-modal">
                    <div class="search-modal-content">
                        <div class="search-input-group">
                            <i class="fas fa-search"></i>
                            <input type="text" id="pdfSearchInput" class="search-input" placeholder="Search in document...">
                        </div>
                        <div class="search-navigation">
                            <button id="prevResult" class="search-nav-btn" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="searchCount" class="search-count">No results</span>
                            <button id="nextResult" class="search-nav-btn" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button id="closeSearchModal" class="search-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <!-- Initial skeleton screen that shows until a PDF is loaded -->
                <div id="pdfInitialSkeleton" class="pdf-initial-skeleton">
                    <div class="pdf-skeleton">
                        <div class="pdf-skeleton-shimmer"></div>
                    </div>
                </div>
                <!-- PDF container -->
                <div id="pdfContainer" class="pdf-container">
                    <!-- PDF pages will be added here -->
                </div>
            </div>
            <div class="pdf-file-bar">
                <div class="pdf-files" id="pdfFiles">
                    <!-- PDF file tabs will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                    Hello! I'm here to help you analyze your documents. What would you like to know?
                </div>
            </div>
        </div>
        <div class="chat-input-container">
            <textarea 
                id="chatInput" 
                placeholder="Type your message here..."
                rows="1"
                oninput="this.style.height='0px'; this.style.height = Math.max(42, Math.min(this.scrollHeight, 150)) + 'px';"
                onkeyup="this.style.height='0px'; this.style.height = Math.max(42, Math.min(this.scrollHeight, 150)) + 'px';"
            ></textarea>
            <button id="sendMessage">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="directCloseModal('settingsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="settings-wrapper">
                    <div class="settings-sidebar">
                        <ul>
                            <li data-setting="appearance" class="active">
                                <i class="fas fa-palette"></i>
                                Appearance
                            </li>
                            <li data-setting="editor">
                                <i class="fas fa-edit"></i>
                                Editor
                            </li>
                            <li data-setting="pdf-viewer">
                                <i class="fas fa-file-pdf"></i>
                                PDF Viewer
                            </li>
                            <li data-setting="about">
                                <i class="fas fa-info-circle"></i>
                                About
                            </li>
                        </ul>
                    </div>
                    <div class="settings-content">
                        <!-- Appearance Panel -->
                        <div id="appearance-panel" class="settings-panel">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Theme</div>
                                    <div class="settings-item-description">Choose between light and dark theme</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="themeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Font Size</div>
                                    <div class="settings-item-description">Adjust the base font size for the application</div>
                                </div>
                                <select class="settings-select" id="fontSize">
                                    <option value="12">12px</option>
                                    <option value="14">14px</option>
                                    <option value="16" selected>16px</option>
                                    <option value="18">18px</option>
                                </select>
                            </div>
                        </div>

                        <!-- Editor Panel -->
                        <div id="editor-panel" class="settings-panel" style="display: none;">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Auto Save</div>
                                    <div class="settings-item-description">Automatically save changes as you type</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoSave" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Spell Check</div>
                                    <div class="settings-item-description">Enable spell checking in the editor</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="spellCheck">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Disable Popups</div>
                                    <div class="settings-item-description">Disable confirmation dialogs when deleting or renaming items</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="disablePopups">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- PDF Viewer Panel -->
                        <div id="pdf-viewer-panel" class="settings-panel" style="display: none;">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Default Zoom Level</div>
                                    <div class="settings-item-description">Set the default zoom level for PDFs</div>
                                </div>
                                <select class="settings-select" id="defaultZoom">
                                    <option value="0.5">50%</option>
                                    <option value="0.75">75%</option>
                                    <option value="1" selected>100%</option>
                                    <option value="1.25">125%</option>
                                    <option value="1.5">150%</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Smooth Scrolling</div>
                                    <div class="settings-item-description">Enable smooth scrolling in PDF viewer</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="smoothScroll" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- About Panel -->
                        <div id="about-panel" class="settings-panel" style="display: none;">
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Version</div>
                                    <div class="settings-item-description">1.0.0</div>
                                </div>
                            </div>
                            <div class="settings-item">
                                <div>
                                    <div class="settings-item-label">Created By</div>
                                    <div class="settings-item-description">Your Team Name</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Note Modal -->
    <div id="newNoteModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 class="modal-title">New Note</h2>
                <button class="modal-close" onclick="directCloseModal('newNoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newNoteForm" onsubmit="event.preventDefault(); createNewNote();">
                    <div class="form-group">
                        <label for="noteName" class="form-label">Note Name</label>
                        <input type="text" id="noteName" class="form-input" placeholder="Enter note name" required>
                    </div>
                    <div class="form-group">
                        <label for="noteDescription" class="form-label">Description</label>
                        <textarea id="noteDescription" class="form-input" rows="3" placeholder="Enter note description"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attachments</label>
                        <div class="drop-zone">
                            <input type="file" id="noteFiles" multiple accept=".pdf,.doc,.docx,.txt,image/*" style="display: none;">
                            <div class="drop-zone-text">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Drop files here or click to upload</span>
                                <span class="small">Supports PDF, images, and documents</span>
                            </div>
                        </div>
                        <div class="file-list">
                            <ul id="selectedNoteFiles"></ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="directCloseModal('newNoteModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="createNewNote()">Create Note</button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="newFolderModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <h2 class="modal-title">New Folder</h2>
                <button class="modal-close" onclick="directCloseModal('newFolderModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newFolderForm" onsubmit="event.preventDefault(); createNewFolder();">
                    <div class="form-group">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input type="text" id="folderName" class="form-input" placeholder="Enter folder name" required>
                    </div>
                    <div class="form-group">
                        <label for="folderDescription" class="form-label">Description</label>
                        <textarea id="folderDescription" class="form-input" rows="3" placeholder="Enter folder description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="directCloseModal('newFolderModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="createNewFolder()">Create Folder</button>
            </div>
        </div>
    </div>
    
    <!-- Load our scripts -->
    <script src="/frontend/src/js/pdf.js"></script>
    <script src="/frontend/src/js/filetree.js"></script>
    <script>
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize file tree
            renderFileTree();
            
            // Initialize PDF viewer
            const pdfContainer = document.getElementById('pdfContainer');
            if (pdfContainer) {
                console.log('[Workspace] PDF container found, initializing PDF viewer');
                if (typeof window.initPDF === 'function') {
                    window.initPDF();
                }
            }
            
            console.log('[Workspace] Application initialized');
        });
        
        // Add error handler for script loading
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('pdf.js')) {
                console.error('[PDF.js Error]', event.message);
            }
        });
    </script>
    
    <!-- Direct script for skeleton handling -->
    <script>
        // Function to hide the skeleton screen
        function hideSkeletonScreen() {
            console.log('[Workspace] Hiding skeleton screen directly');
            const skeleton = document.getElementById('pdfInitialSkeleton');
            if (skeleton) {
                skeleton.classList.add('hidden');
                skeleton.style.display = 'none';
                console.log('[Workspace] Skeleton screen hidden');
            }
        }
        
        // Function to show the skeleton screen
        function showSkeletonScreen() {
            console.log('[Workspace] Showing skeleton screen directly');
            const skeleton = document.getElementById('pdfInitialSkeleton');
            if (skeleton) {
                skeleton.classList.remove('hidden');
                skeleton.style.display = 'flex';
                console.log('[Workspace] Skeleton screen shown');
            }
        }
        
        // Add a mutation observer to detect when PDF pages are added
        document.addEventListener('DOMContentLoaded', function() {
            const pdfPagesContainer = document.getElementById('pdfPagesContainer');
            if (pdfPagesContainer) {
                console.log('[Workspace] Setting up mutation observer for PDF pages container');
                
                // Create a mutation observer to watch for changes
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // Check if any PDF pages were added
                            const pdfPages = pdfPagesContainer.querySelectorAll('.pdf-page');
                            if (pdfPages.length > 0) {
                                console.log('[Workspace] PDF pages detected, hiding skeleton screen');
                                hideSkeletonScreen();
                            }
                        }
                    });
                });
                
                // Start observing the container for changes
                observer.observe(pdfPagesContainer, { childList: true, subtree: true });
            }
        });
    </script>
    
    <!-- Test function for direct PDF rendering -->
    <script>
        // Direct test function for PDF rendering
        function testDirectPDFRendering() {
            console.log('[Test] Direct PDF rendering test started');
            
            // Try different paths to find the correct one
            const possiblePaths = [
                '/assets/Files/final review.pdf',
                './assets/Files/final review.pdf',
                '../assets/Files/final review.pdf',
                '/frontend/public/assets/Files/final review.pdf',
                'frontend/public/assets/Files/final review.pdf',
                '/home/banana/projects/SmartWrite/frontend/public/assets/Files/final review.pdf'
            ];
            
            let pathIndex = 0;
            
            function tryNextPath() {
                if (pathIndex >= possiblePaths.length) {
                    console.error('[Test] All paths failed');
                    const pdfContainer = document.getElementById('pdfPagesContainer');
                    if (pdfContainer) {
                        pdfContainer.innerHTML = '<div class="pdf-error">Failed to load PDF from any path</div>';
                    }
                    return;
                }
                
                const pdfUrl = possiblePaths[pathIndex];
                console.log(`[Test] Trying path ${pathIndex + 1}/${possiblePaths.length}: ${pdfUrl}`);
                
                const pdfContainer = document.getElementById('pdfPagesContainer');
                if (!pdfContainer) {
                    console.error('[Test] pdfPagesContainer not found');
                    return;
                }
                
                // Show loading indicator
                pdfContainer.innerHTML = '';
                
                // Load the PDF
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                
                loadingTask.promise.then(function(pdf) {
                    console.log(`[Test] PDF loaded successfully from path: ${pdfUrl}`);
                    console.log(`[Test] PDF has ${pdf.numPages} pages`);
                    
                    // Clear container
                    pdfContainer.innerHTML = '';
                    
                    // Create a document fragment to hold all pages
                    const fragment = document.createDocumentFragment();
                    
                    // Function to render a specific page
                    function renderPage(pageNum) {
                        return pdf.getPage(pageNum).then(function(page) {
                            console.log(`[Test] Rendering page ${pageNum}`);
                            
                            // Create a div for this page
                            const pageDiv = document.createElement('div');
                            pageDiv.className = 'pdf-page';
                            pageDiv.dataset.pageNumber = pageNum;
                            
                            // Create a canvas for this page
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Set viewport
                            const viewport = page.getViewport({ scale: 1.0 });
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            // Render the page content on the canvas
                            const renderContext = {
                                canvasContext: ctx,
                                viewport: viewport
                            };
                            
                            return page.render(renderContext).promise.then(function() {
                                console.log(`[Test] Page ${pageNum} rendered successfully`);
                                
                                // Add the canvas to the page div
                                pageDiv.appendChild(canvas);
                                
                                // Page number indicators have been removed as requested
                                
                                return pageDiv;
                            });
                        });
                    }
                    
                    // Create an array of promises for all pages
                    const renderPromises = [];
                    for (let i = 1; i <= pdf.numPages; i++) {
                        renderPromises.push(renderPage(i));
                    }
                    
                    // Wait for all pages to be rendered
                    Promise.all(renderPromises).then(pageDivs => {
                        console.log(`[Test] All ${pageDivs.length} pages rendered successfully`);
                        
                        // Add all page divs to the fragment
                        pageDivs.forEach(pageDiv => {
                            fragment.appendChild(pageDiv);
                        });
                        
                        // Append all pages to the container
                        pdfContainer.appendChild(fragment);
                        console.log('[Test] All pages added to container');
                        
                        // Update all file paths in the file system
                        updateFilePaths(pdfUrl);
                    }).catch(function(error) {
                        console.error(`[Workspace] Error rendering PDF from path ${pdfUrl}:`, error);
                        pdfContainer.innerHTML = `<div class="pdf-error"><i class="fas fa-exclamation-triangle"></i> Error rendering PDF: ${error.message}</div>`;
                        pathIndex++;
                        tryNextPath();
                    });
                }).catch(function(error) {
                    console.error(`[Workspace] Error loading PDF from path ${pdfUrl}:`, error);
                    pdfContainer.innerHTML = `<div class="pdf-error"><i class="fas fa-exclamation-triangle"></i> Error loading PDF: ${error.message}</div>`;
                    pathIndex++;
                    tryNextPath();
                });
            }
            
            // Function to update all file paths in the file system
            function updateFilePaths(successfulPath) {
                // Extract the base path
                const basePath = successfulPath.substring(0, successfulPath.lastIndexOf('/') + 1);
                console.log(`[Test] Updating all file paths to use base path: ${basePath}`);
                
                // Update paths in the file system
                function updatePaths(folder) {
                    if (folder.children) {
                        folder.children.forEach(item => {
                            if (item.type === 'file' && item.fileType === 'pdf') {
                                const fileName = item.path.substring(item.path.lastIndexOf('/') + 1);
                                item.path = basePath + fileName;
                                console.log(`[Test] Updated path for ${item.name} to ${item.path}`);
                            } else if (item.type === 'folder') {
                                updatePaths(item);
                            }
                        });
                    }
                }
                
                // Get the file system from the window object
                if (window.fileSystem) {
                    updatePaths(window.fileSystem);
                    console.log('[Test] All file paths updated');
                } else {
                    console.warn('[Test] fileSystem not found in window object');
                }
            }
            
            // Start trying paths
            tryNextPath();
        }
        
        // Commented out automatic test to allow proper file selection from the file tree
        // setTimeout(testDirectPDFRendering, 2000);
    </script>
    
    <!-- Fallback script for direct modal control -->
    <script>
        // Direct modal control functions
        function directOpenModal(modalId) {
            console.log('Direct open modal called for: ' + modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                console.error('Modal not found: ' + modalId);
            }
        }
        
        function directCloseModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // If closing the settings modal, save all settings
                if (modalId === 'settingsModal') {
                    saveAllSettings(false); // Pass false to not close the modal again (would cause infinite loop)
                }
                
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // File tree functionality
        // Sample file structure
        const fileSystem = {
            id: 'root',
            name: 'My Files',
            type: 'folder',
            children: [
                {
                    id: 'folder1',
                    name: 'Study Notes',
                    type: 'folder',
                    children: [
                        {
                            id: 'file1',
                            name: 'final review.pdf',
                            type: 'file',
                            fileType: 'pdf',
                            path: '/assets/Files/final review.pdf'
                        },
                        {
                            id: 'file2',
                            name: 'HW 3-Ch1.pdf',
                            type: 'file',
                            fileType: 'pdf',
                            path: '/assets/Files/HW 3-Ch1.pdf'
                        }
                    ]
                },
                {
                    id: 'folder2',
                    name: 'Project Research',
                    type: 'folder',
                    children: [
                        {
                            id: 'file3',
                            name: 'Appendix.pdf',
                            type: 'file',
                            fileType: 'pdf',
                            path: '/assets/Files/Appendix.pdf'
                        }
                    ]
                }
            ]
        };
        
        // Export fileSystem to window object for debugging
        window.fileSystem = fileSystem;
        
        // Track expanded folders
        const expandedFolders = new Set(['root']);
        
        // Track selected item
        let selectedItemId = null;
        
        // Chat functionality
        // Array to store chat messages
        const chatHistory = [];
        
        // Message types
        const MESSAGE_TYPE = {
            USER: 'user',
            ASSISTANT: 'assistant'
        };
        
        // Function to send a chat message
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            
            // Check if input is not empty
            if (chatInput && chatInput.value.trim() !== '') {
                const messageText = chatInput.value.trim();
                
                // Create message object
                const userMessage = {
                    type: MESSAGE_TYPE.USER,
                    text: messageText,
                    timestamp: new Date().toISOString()
                };
                
                // Add to chat history
                chatHistory.push(userMessage);
                console.log('Added user message to history:', userMessage);
                
                // Create and append user message element
                const userMessageElement = document.createElement('div');
                userMessageElement.className = 'message user';
                userMessageElement.innerHTML = `
                    <div class="message-content">
                        ${messageText}
                    </div>
                `;
                chatMessages.appendChild(userMessageElement);
                
                // Clear input
                chatInput.value = '';
                chatInput.style.height = 'auto';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Simulate assistant response
                setTimeout(() => {
                    // Create response text (in a real app, this would come from an API)
                    const responseText = `I received your message: "${messageText}". This is a simulated response.`;
                    
                    // Create message object
                    const assistantMessage = {
                        type: MESSAGE_TYPE.ASSISTANT,
                        text: responseText,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Add to chat history
                    chatHistory.push(assistantMessage);
                    console.log('Added assistant message to history:', assistantMessage);
                    
                    // Create and append assistant message element
                    const assistantMessageElement = document.createElement('div');
                    assistantMessageElement.className = 'message assistant';
                    assistantMessageElement.innerHTML = `
                        <div class="message-content">
                            ${responseText}
                        </div>
                    `;
                    chatMessages.appendChild(assistantMessageElement);
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1000);
                
                // Return the user message for potential further processing
                return userMessage;
            }
            
            return null;
        }
        
        // Function to get chat history
        function getChatHistory() {
            return [...chatHistory]; // Return a copy to prevent direct modification
        }
        
        // Function to clear chat history
        function clearChatHistory() {
            chatHistory.length = 0;
            const chatMessages = document.getElementById('chatMessages');
            
            // Keep only the initial greeting message
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="message assistant">
                        <div class="message-content">
                            Hello! I'm here to help you analyze your documents. What would you like to know?
                        </div>
                    </div>
                `;
            }
            
            console.log('Chat history cleared');
        }
        
        // Initialize settings tabs
        function initSettingsTabs() {
            console.log('Initializing settings tabs');
            const settingsTabs = document.querySelectorAll('.settings-sidebar li');
            
            if (settingsTabs.length > 0) {
                console.log(`Found ${settingsTabs.length} settings tabs`);
                
                // Add click event to each tab
                settingsTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        console.log(`Tab clicked: ${this.getAttribute('data-setting')}`);
                        
                        // Remove active class from all tabs
                        settingsTabs.forEach(t => t.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Hide all panels
                        document.querySelectorAll('.settings-panel').forEach(panel => {
                            panel.style.display = 'none';
                        });
                        
                        // Show the selected panel
                        const panelId = this.getAttribute('data-setting') + '-panel';
                        const panel = document.getElementById(panelId);
                        if (panel) {
                            console.log(`Showing panel: ${panelId}`);
                            panel.style.display = 'block';
                        } else {
                            console.error(`Panel not found: ${panelId}`);
                        }
                    });
                });
                
                // Initialize with the first tab active
                const activeTab = document.querySelector('.settings-sidebar li.active') || settingsTabs[0];
                if (activeTab) {
                    console.log(`Setting initial active tab: ${activeTab.getAttribute('data-setting')}`);
                    const panelId = activeTab.getAttribute('data-setting') + '-panel';
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.style.display = 'block';
                    }
                }
            } else {
                console.error('No settings tabs found');
            }
        }
        
        // Load saved settings
        function loadSettings() {
            console.log('Loading saved settings');
            
            // Load theme setting
            const savedTheme = localStorage.getItem('darkMode');
            const themeToggle = document.getElementById('themeToggle');
            if (savedTheme !== null && themeToggle) {
                themeToggle.checked = savedTheme === 'true';
                document.documentElement.setAttribute('data-theme', themeToggle.checked ? 'dark' : 'light');
            }
            
            // Load zoom setting
            const savedZoom = localStorage.getItem('defaultZoom');
            const defaultZoom = document.getElementById('defaultZoom');
            if (savedZoom !== null && defaultZoom) {
                defaultZoom.value = savedZoom;
            }
            
            // Load other settings
            const savedAutoSave = localStorage.getItem('autoSave');
            const autoSave = document.getElementById('autoSave');
            if (savedAutoSave !== null && autoSave) {
                autoSave.checked = savedAutoSave === 'true';
            }
            
            const savedSpellCheck = localStorage.getItem('spellCheck');
            const spellCheck = document.getElementById('spellCheck');
            if (savedSpellCheck !== null && spellCheck) {
                spellCheck.checked = savedSpellCheck === 'true';
            }
            
            const savedDisablePopups = localStorage.getItem('disablePopups');
            const disablePopups = document.getElementById('disablePopups');
            if (savedDisablePopups !== null && disablePopups) {
                disablePopups.checked = savedDisablePopups === 'true';
            }
            
            const savedSmoothScroll = localStorage.getItem('smoothScroll');
            const smoothScroll = document.getElementById('smoothScroll');
            if (savedSmoothScroll !== null && smoothScroll) {
                smoothScroll.checked = savedSmoothScroll === 'true';
            }
            
            const savedFontSize = localStorage.getItem('fontSize');
            const fontSize = document.getElementById('fontSize');
            if (savedFontSize !== null && fontSize) {
                fontSize.value = savedFontSize;
            }
        }
        
        // Save settings
        function saveAllSettings(shouldCloseModal = true) {
            console.log('Saving all settings');
            
            // Save theme setting
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                localStorage.setItem('darkMode', themeToggle.checked);
                document.documentElement.setAttribute('data-theme', themeToggle.checked ? 'dark' : 'light');
            }
            
            // Save zoom setting
            const defaultZoom = document.getElementById('defaultZoom');
            if (defaultZoom) {
                localStorage.setItem('defaultZoom', defaultZoom.value);
            }
            
            // Save other settings
            const autoSave = document.getElementById('autoSave');
            if (autoSave) {
                localStorage.setItem('autoSave', autoSave.checked);
            }
            
            const spellCheck = document.getElementById('spellCheck');
            if (spellCheck) {
                localStorage.setItem('spellCheck', spellCheck.checked);
            }
            
            const disablePopups = document.getElementById('disablePopups');
            if (disablePopups) {
                localStorage.setItem('disablePopups', disablePopups.checked);
            }
            
            const smoothScroll = document.getElementById('smoothScroll');
            if (smoothScroll) {
                localStorage.setItem('smoothScroll', smoothScroll.checked);
            }
            
            const fontSize = document.getElementById('fontSize');
            if (fontSize) {
                localStorage.setItem('fontSize', fontSize.value);
                document.documentElement.style.fontSize = fontSize.value + 'px';
            }
            
            // Close the modal if requested
            if (shouldCloseModal) {
                directCloseModal('settingsModal');
            }
        }
        
        // Add event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Direct script loaded');
            
            // Add click handler to settings button
            const settingsBtn = document.getElementById('sidebarSettingsBtn');
            if (settingsBtn) {
                console.log('Settings button found in direct script');
                settingsBtn.onclick = function() {
                    console.log('Settings button clicked in direct script');
                    directOpenModal('settingsModal');
                    // Initialize tabs when modal is opened
                    initSettingsTabs();
                    // Load saved settings
                    loadSettings();
                    return false;
                };
            }
            
            // Add click handlers to close buttons
            const closeButtons = document.querySelectorAll('.modal-close');
            closeButtons.forEach(function(btn) {
                btn.onclick = function() {
                    const modalId = this.closest('.modal-overlay').id;
                    directCloseModal(modalId);
                    return false;
                };
            });
            
            // Add event listeners for settings changes
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('change', function() {
                    document.documentElement.setAttribute('data-theme', this.checked ? 'dark' : 'light');
                });
            }
            
            const fontSize = document.getElementById('fontSize');
            if (fontSize) {
                fontSize.addEventListener('change', function() {
                    document.documentElement.style.fontSize = this.value + 'px';
                });
            }
            
            // Add click handler to modal overlay for closing when clicking outside
            const modalOverlays = document.querySelectorAll('.modal-overlay');
            modalOverlays.forEach(function(overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        directCloseModal(this.id);
                    }
                });
            });
            
            // Add event listeners for chat
            const sendButton = document.getElementById('sendMessage');
            if (sendButton) {
                sendButton.addEventListener('click', function() {
                    sendChatMessage();
                });
            }
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    // Send message on Enter key (but not with Shift+Enter)
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Prevent default to avoid newline
                        sendChatMessage();
                    }
                });
            }
            
            // Initialize file tree
            renderFileTree();
            
            // Add click handlers for file tree action buttons
            const newNoteBtn = document.querySelector('.file-tree-actions .action-btn:nth-child(1)');
            if (newNoteBtn) {
                newNoteBtn.addEventListener('click', function() {
                    directOpenModal('newNoteModal');
                });
            }
            
            const newFolderBtn = document.querySelector('.file-tree-actions .action-btn:nth-child(2)');
            if (newFolderBtn) {
                newFolderBtn.addEventListener('click', function() {
                    directOpenModal('newFolderModal');
                });
            }
            
            const sortBtn = document.querySelector('.file-tree-actions .action-btn:nth-child(3)');
            if (sortBtn) {
                sortBtn.addEventListener('click', function() {
                    const sortMenu = document.getElementById('sortMenu');
                    if (sortMenu) {
                        sortMenu.classList.toggle('active');
                    }
                });
            }
            
            // Add click handler to sort menu items
            document.querySelectorAll('.sort-menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const sortType = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    sortFileSystem(sortType);
                    document.getElementById('sortMenu').classList.remove('active');
                });
            });
        });
        
        // Function to render the file tree
        function renderFileTree() {
            const fileTreeElement = document.getElementById('fileTree');
            if (!fileTreeElement) return;
            
            // Clear existing content
            fileTreeElement.innerHTML = '';
            
            // Render the root folder's children
            renderFolder(fileTreeElement, fileSystem);
            
            console.log('File tree rendered');
        }
        
        // Function to render a folder and its children
        function renderFolder(parentElement, folder) {
            const isExpanded = expandedFolders.has(folder.id);
            
            if (folder.id !== 'root') {
                // Create folder item
                const folderElement = document.createElement('div');
                folderElement.className = 'tree-item' + (isExpanded ? ' expanded' : '');
                folderElement.dataset.id = folder.id;
                
                // Create folder content
                const folderContent = document.createElement('div');
                folderContent.className = 'tree-item-content' + (selectedItemId === folder.id ? ' selected' : '');
                folderContent.innerHTML = `
                    <span class="tree-item-toggle"><i class="fas fa-chevron-right"></i></span>
                    <span class="tree-item-icon"><i class="fas fa-folder${isExpanded ? '-open' : ''}"></i></span>
                    <span class="tree-item-text">${folder.name}</span>
                `;
                
                // Add click event to toggle folder
                folderContent.addEventListener('click', function(e) {
                    // If clicking on the toggle icon or anywhere on the folder content
                    toggleFolder(folder.id);
                    e.stopPropagation();
                    // No longer selecting the folder when clicked
                });
                
                folderElement.appendChild(folderContent);
                
                // Create container for children
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-item-children';
                folderElement.appendChild(childrenContainer);
                
                parentElement.appendChild(folderElement);
                
                // If expanded, render children
                if (isExpanded && folder.children && folder.children.length > 0) {
                    folder.children.forEach(child => {
                        if (child.type === 'folder') {
                            renderFolder(childrenContainer, child);
                        } else {
                            renderFile(childrenContainer, child);
                        }
                    });
                }
            } else {
                // For root folder, just render its children directly
                if (folder.children && folder.children.length > 0) {
                    folder.children.forEach(child => {
                        if (child.type === 'folder') {
                            renderFolder(parentElement, child);
                        } else {
                            renderFile(parentElement, child);
                        }
                    });
                }
            }
        }
        
        // Function to render a file
        function renderFile(parentElement, file) {
            const fileElement = document.createElement('div');
            fileElement.className = 'tree-item';
            fileElement.dataset.id = file.id;
            
            // Create file content
            const fileContent = document.createElement('div');
            fileContent.className = 'tree-item-content' + (selectedItemId === file.id ? ' selected' : '');
            
            // Choose icon based on file type
            let fileIcon = 'fa-file';
            if (file.fileType === 'pdf') {
                fileIcon = 'fa-file-pdf';
            } else if (file.fileType === 'image') {
                fileIcon = 'fa-file-image';
            } else if (file.fileType === 'doc' || file.fileType === 'docx') {
                fileIcon = 'fa-file-word';
            }
            
            fileContent.innerHTML = `
                <span class="tree-item-toggle" style="visibility: hidden;"><i class="fas ${fileIcon}"></i></span>
                <span class="tree-item-text">${file.name}</span>
            `;
            
            // Add click event to select file
            fileContent.addEventListener('click', function() {
                selectItem(file.id);
                // Simulate opening the file
                console.log(`Opening file: ${file.name}`);
            });
            
            fileElement.appendChild(fileContent);
            parentElement.appendChild(fileElement);
        }
        
        // Function to toggle folder expansion
        function toggleFolder(folderId) {
            if (expandedFolders.has(folderId)) {
                expandedFolders.delete(folderId);
            } else {
                expandedFolders.add(folderId);
            }
            
            renderFileTree();
        }
        
        // Function to select an item
        function selectItem(itemId) {
            console.log(`[Workspace] selectItem called with itemId: ${itemId}`);
            
            // Find the item in the file system
            const findItem = (folder) => {
                if (folder.id === itemId) {
                    return folder;
                }
                
                if (folder.children) {
                    for (const child of folder.children) {
                        const found = findItem(child);
                        if (found) return found;
                    }
                }
                
                return null;
            };
            
            const item = findItem(fileSystem);
            
            if (!item) {
                console.error(`[Workspace] Item with id ${itemId} not found in file system`);
                return;
            }
            
            console.log(`[Workspace] Found item:`, item);
            
            // Only select the item if it's a file
            if (item && item.type === 'file') {
                selectedItemId = itemId;
                console.log(`[Workspace] Selected item ID set to: ${selectedItemId}`);
                
                // Remove selected class from all items
                document.querySelectorAll('.tree-item-content').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selected class to selected item
                const selectedItem = document.querySelector(`.tree-item[data-id="${itemId}"] > .tree-item-content`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
                
                console.log(`[Workspace] Selected item: ${itemId}`);
                
                // Load the PDF file if it's a PDF
                if (item.fileType === 'pdf') {
                    console.log(`[Workspace] Item is a PDF, path: ${item.path}`);
                    
                    // Check if path is valid
                    if (!item.path || item.path === '#') {
                        console.error(`[Workspace] Invalid PDF path: ${item.path}`);
                        return;
                    }
                    
                    // Show loading state
                    const pdfViewer = document.getElementById('pdfViewer');
                    const pdfContainer = document.getElementById('pdfContainer');
                    
                    if (pdfViewer) {
                        // Store the search modal if it exists
                        const searchModal = document.getElementById('searchModal');
                        
                        // Clear previous content while preserving the search modal
                        const elementsToKeep = [];
                        if (searchModal) {
                            elementsToKeep.push(searchModal);
                        }
                        
                        // Clear the viewer
                        pdfViewer.innerHTML = '';
                        
                        // Restore preserved elements
                        elementsToKeep.forEach(element => {
                            pdfViewer.appendChild(element);
                        });
                        
                        // Create and show loading indicator
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'pdf-loading';
                        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading PDF...';
                        pdfViewer.appendChild(loadingDiv);
                        
                        // Create container for PDF
                        const container = document.createElement('div');
                        container.id = 'pdfContainer';
                        container.className = 'pdf-container';
                        pdfViewer.appendChild(container);
                    }
                    
                    // Try to load PDF using PDF.js
                    if (typeof pdfjsLib !== 'undefined') {
                        console.log('[Workspace] Loading PDF with PDF.js');
                        const loadingTask = pdfjsLib.getDocument(item.path);
                        
                        loadingTask.promise.then(async function(pdf) {
                            console.log(`[Workspace] PDF loaded successfully with ${pdf.numPages} pages`);
                            
                            // Clear the container
                            const pdfContainer = document.getElementById('pdfContainer');
                            if (pdfContainer) {
                                pdfContainer.innerHTML = '';
                                
                                // Render all pages
                                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                                    await renderPage(pdf, pageNum);
                                }
                                
                                // Remove loading indicator
                                const loadingDiv = pdfViewer.querySelector('.pdf-loading');
                                if (loadingDiv) {
                                    loadingDiv.remove();
                                }
                            }
                        }).catch(function(error) {
                            console.error('[Workspace] Error loading PDF:', error);
                            // Show error message
                            const pdfContainer = document.getElementById('pdfContainer');
                            if (pdfContainer) {
                                pdfContainer.innerHTML = `
                                    <div class="pdf-error">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Error loading PDF: ${error.message}
                                    </div>`;
                            }
                            // Remove loading indicator
                            const loadingDiv = pdfViewer.querySelector('.pdf-loading');
                            if (loadingDiv) {
                                loadingDiv.remove();
                            }
                        });
                    } else {
                        console.warn('[Workspace] PDF.js not available, using fallback');
                        // Fallback to direct PDF loading
                        const pdfContainer = document.getElementById('pdfContainer');
                        if (pdfContainer) {
                            pdfContainer.innerHTML = `
                                <object data="${item.path}" type="application/pdf" width="100%" height="100%">
                                    <p>Your browser does not support PDFs. <a href="${item.path}">Download the PDF</a>.</p>
                                </object>`;
                        }
                        // Remove loading indicator
                        const loadingDiv = pdfViewer.querySelector('.pdf-loading');
                        if (loadingDiv) {
                            loadingDiv.remove();
                        }
                    }
                } else {
                    console.log(`[Workspace] Item is not a PDF, fileType: ${item.fileType}`);
                }
            } else {
                console.log(`[Workspace] Item is not a file, type: ${item.type}`);
            }
        }
        
        // Function to create a new folder
        function createNewFolder() {
            const folderName = document.getElementById('folderName').value.trim();
            if (!folderName) return;
            
            // Call the module function
            window.createNewFolder(folderName);
            
            // Close modal
            directCloseModal('newFolderModal');
        }
        
        // Function to create a new note
        function createNewNote() {
            const noteName = document.getElementById('noteName').value.trim();
            if (!noteName) return;
            
            // Call the module function
            window.createNewNote(noteName);
            
            // Close modal
            directCloseModal('newNoteModal');
        }
        
        // Function to sort the file system
        function sortFileSystem(sortType) {
            console.log(`Sorting by: ${sortType}`);
            
            // Sort function
            const sortFunction = (a, b) => {
                // Folders always come before files
                if (a.type === 'folder' && b.type === 'file') return -1;
                if (a.type === 'file' && b.type === 'folder') return 1;
                
                // Sort by name
                if (sortType === 'name') {
                    return a.name.localeCompare(b.name);
                }
                
                // For demo purposes, other sort types just use name
                return a.name.localeCompare(b.name);
            };
            
            // Sort root children
            fileSystem.children.sort(sortFunction);
            
            // Sort children of all folders
            const sortFolderChildren = (folder) => {
                if (folder.children && folder.children.length > 0) {
                    folder.children.sort(sortFunction);
                    folder.children.forEach(child => {
                        if (child.type === 'folder') {
                            sortFolderChildren(child);
                        }
                    });
                }
            };
            
            sortFolderChildren(fileSystem);
            
            // Re-render file tree
            renderFileTree();
        }
        
        // Function to sort files
        function sortFiles(sortType) {
            // Call the module function
            window.sortFiles(sortType);
        }

        // Function to render a single PDF page
        async function renderPage(pdf, pageNum) {
            console.log(`[Workspace] Rendering page ${pageNum}`);
            
            try {
                const page = await pdf.getPage(pageNum);
                const originalViewport = page.getViewport({ scale: 1.0 });
                
                // Calculate scale to fit the page width while maintaining aspect ratio
                const containerWidth = document.getElementById('pdfContainer').clientWidth - 40; // Account for padding
                const scale = Math.min(containerWidth / originalViewport.width, 1.0);
                const viewport = page.getViewport({ scale });
                
                // Create page container
                const pageContainer = document.createElement('div');
                pageContainer.className = 'pdf-page';
                pageContainer.dataset.pageNumber = pageNum;
                pageContainer.style.width = `${viewport.width}px`;
                pageContainer.style.height = `${viewport.height}px`;
                
                // Create canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                // Create text layer div
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                textLayerDiv.style.width = `${viewport.width}px`;
                textLayerDiv.style.height = `${viewport.height}px`;
                
                // Create wrapper for canvas and text layer
                const wrapper = document.createElement('div');
                wrapper.className = 'pdf-page-wrapper';
                wrapper.style.width = `${viewport.width}px`;
                wrapper.style.height = `${viewport.height}px`;
                
                // Render page content
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                    enableWebGL: true,
                    renderInteractiveForms: true
                };
                
                await page.render(renderContext).promise;
                
                // Get text content with improved positioning and font info
                const textContent = await page.getTextContent({
                    normalizeWhitespace: true,
                    disableCombineTextItems: false,
                    includeMarkedContent: true,
                    includeStyles: true  // Get font size information
                });
                
                // Calculate base font size from viewport
                const baseFontSize = Math.floor(12 * scale);
                
                // Add font size to the text layer div
                textLayerDiv.style.fontSize = `${baseFontSize}px`;
                
                // Render text layer with improved alignment and positioning
                await pdfjsLib.renderTextLayer({
                    textContent: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: [],
                    enhanceTextSelection: true,
                    textLayerMode: 1,
                    renderInteractiveForms: true,
                    useCanvasWidth: false,
                    isOffscreenCanvasSupported: true,
                    expandTextDivs: false
                }).promise;
                
                // After rendering, adjust spans based on their font size
                const spans = textLayerDiv.querySelectorAll('span');
                spans.forEach(span => {
                    if (span.style.fontSize) {
                        // Extract the original font size and calculate scale factor
                        const originalSize = parseFloat(span.style.fontSize);
                        const scaleFactor = originalSize / baseFontSize;
                        
                        // Apply scaling transform if font size differs from base size
                        if (scaleFactor !== 1) {
                            span.style.transform = `scale(${scaleFactor})`;
                            span.style.transformOrigin = 'left top';
                            
                            // Adjust the height to match the scaled size
                            span.style.height = (originalSize / baseFontSize * 100) + '%';
                        }
                    }
                });
                
                // Add elements to page container
                wrapper.appendChild(canvas);
                wrapper.appendChild(textLayerDiv);
                pageContainer.appendChild(wrapper);
                
                // Add page container to PDF container
                const pdfContainer = document.getElementById('pdfContainer');
                if (pdfContainer) {
                    pdfContainer.appendChild(pageContainer);
                }
                
                console.log(`[Workspace] Page ${pageNum} rendered successfully with dimensions: ${viewport.width}x${viewport.height}`);
            } catch (error) {
                console.error(`[Workspace] Error rendering page ${pageNum}:`, error);
                throw error;
            }
        }

        // Global search variables
        let currentSearchResults = [];
        let currentResultIndex = -1;

        function clearSearchHighlights() {
            document.querySelectorAll('.search-highlight').forEach(highlight => highlight.remove());
            currentSearchResults = [];
            currentResultIndex = -1;
        }

        function highlightSearchResults(searchTerm) {
            if (!searchTerm) return;
            
            clearSearchHighlights();
            
            const textLayers = document.querySelectorAll('.textLayer');
            const searchRegex = new RegExp(searchTerm, 'gi');
            let totalMatches = 0;
            
            textLayers.forEach(textLayer => {
                const textElements = textLayer.querySelectorAll('span');
                const textLayerRect = textLayer.getBoundingClientRect();
                
                textElements.forEach(span => {
                    const text = span.textContent;
                    let match;
                    
                    // Get the span's computed style for accurate measurements
                    const spanStyle = window.getComputedStyle(span);
                    const spanRect = span.getBoundingClientRect();
                    
                    while ((match = searchRegex.exec(text)) !== null) {
                        const highlight = document.createElement('div');
                        highlight.className = 'search-highlight';
                        
                        // Calculate the position of the match within the span
                        const preMatchText = text.substring(0, match.index);
                        const matchText = match[0];
                        
                        // Create temporary span for measurements
                        const tempSpan = document.createElement('span');
                        Object.assign(tempSpan.style, {
                            font: spanStyle.font,
                            fontSize: spanStyle.fontSize,
                            letterSpacing: spanStyle.letterSpacing,
                            position: 'absolute',
                            visibility: 'hidden',
                            whiteSpace: 'pre',
                            display: 'inline-block',
                            transform: 'none'
                        });
                        
                        // Measure pre-match width
                        tempSpan.textContent = preMatchText;
                        document.body.appendChild(tempSpan);
                        const preMatchWidth = tempSpan.getBoundingClientRect().width;
                        
                        // Measure match width
                        tempSpan.textContent = matchText;
                        const matchWidth = tempSpan.getBoundingClientRect().width;
                        tempSpan.remove();
                        
                        // Get the transform matrix from the span
                        const transform = spanStyle.transform;
                        const matrix = new DOMMatrix(transform);
                        const scale = matrix.a; // Horizontal scale factor
                        
                        // Calculate position relative to text layer, accounting for transform
                        const scaledPreMatchWidth = preMatchWidth * scale;
                        const scaledMatchWidth = matchWidth * scale;
                        const left = spanRect.left - textLayerRect.left + scaledPreMatchWidth;
                        const top = spanRect.top - textLayerRect.top;
                        
                        // Position and size the highlight
                        highlight.style.left = `${left}px`;
                        highlight.style.top = `${top}px`;
                        highlight.style.width = `${scaledMatchWidth}px`;
                        highlight.style.height = `${spanRect.height}px`;
                        
                        // Apply the same transform as the text span
                        highlight.style.transform = transform;
                        highlight.style.transformOrigin = 'left top';
                        
                        textLayer.appendChild(highlight);
                        currentSearchResults.push({
                            element: highlight,
                            page: textLayer.closest('.pdf-page')
                        });
                        totalMatches++;
                    }
                });
            });
            
            if (currentSearchResults.length > 0) {
                currentResultIndex = 0;
                const current = currentSearchResults[0];
                current.element.classList.add('current');
                current.page.scrollIntoView({ behavior: 'smooth', block: 'center' });
                updateSearchCount();
            }
            
            console.log(`Found ${totalMatches} matches for "${searchTerm}"`);
        }

        function navigateSearchResults(direction) {
            if (currentSearchResults.length === 0) return;
            
            currentSearchResults[currentResultIndex].element.classList.remove('current');
            
            if (direction === 'next') {
                currentResultIndex = (currentResultIndex + 1) % currentSearchResults.length;
            } else {
                currentResultIndex = (currentResultIndex - 1 + currentSearchResults.length) % currentSearchResults.length;
            }
            
            const current = currentSearchResults[currentResultIndex];
            current.element.classList.add('current');
            current.page.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateSearchCount();
        }

        // Initialize search controls - Updated
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Search] Initializing search controls');
            
            const searchIcon = document.getElementById('searchIcon');
            const searchModal = document.getElementById('searchModal');
            const closeSearchModal = document.getElementById('closeSearchModal');
            const searchInput = document.getElementById('pdfSearchInput');
            const prevResult = document.getElementById('prevResult');
            const nextResult = document.getElementById('nextResult');
            const searchCount = document.getElementById('searchCount');
            
            console.log('[Search] Elements found:', {
                searchIcon: !!searchIcon,
                searchModal: !!searchModal,
                closeSearchModal: !!closeSearchModal,
                searchInput: !!searchInput,
                prevResult: !!prevResult,
                nextResult: !!nextResult,
                searchCount: !!searchCount
            });
            
            if (searchIcon && searchModal && closeSearchModal) {
                // Toggle search modal
                searchIcon.addEventListener('click', (e) => {
                    console.log('[Search] Search icon clicked');
                    e.stopPropagation(); // Prevent event from bubbling up
                    searchModal.style.display = 'block';
                    searchModal.style.opacity = '1';
                    searchModal.style.visibility = 'visible';
                    searchModal.classList.add('active');
                    console.log('[Search] Search modal display:', searchModal.style.display);
                    console.log('[Search] Search modal classes:', searchModal.className);
                    
                    if (searchInput) {
                        searchInput.value = ''; // Clear previous search
                        searchInput.focus();
                        clearSearchHighlights();
                    }
                });
                
                // Function to close the modal with animation
                function closeModalWithAnimation() {
                    searchModal.classList.remove('active');
                    // Wait for animation to complete before hiding
                    setTimeout(() => {
                        searchModal.style.display = 'none';
                        searchModal.style.opacity = '0';
                        searchModal.style.visibility = 'hidden';
                        clearSearchHighlights();
                    }, 500); // Match the animation duration
                }
                
                // Updated close button behavior
                closeSearchModal.addEventListener('click', (e) => {
                    console.log('[Search] Close button clicked');
                    e.stopPropagation(); // Prevent event from bubbling up
                    if (searchInput && searchInput.value.trim() !== '') {
                        // If there's text, clear it
                        searchInput.value = '';
                        clearSearchHighlights();
                        updateSearchCount();
                    } else {
                        // If no text, close the modal with animation
                        closeModalWithAnimation();
                    }
                });
                
                // Close modal when clicking outside
                document.addEventListener('click', (e) => {
                    if (searchModal.style.display === 'block' && 
                        e.target !== searchModal && 
                        !searchModal.contains(e.target) && 
                        e.target !== searchIcon && 
                        !searchIcon.contains(e.target)) {
                        closeModalWithAnimation();
                    }
                });
            }
            
            if (searchInput) {
                // Search input events
                let debounceTimeout;
                searchInput.addEventListener('input', () => {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        const searchTerm = searchInput.value.trim();
                        if (searchTerm) {
                            highlightSearchResults(searchTerm);
                            updateSearchCount();
                        } else {
                            clearSearchHighlights();
                            updateSearchCount();
                        }
                    }, 300); // Debounce search for better performance
                });
                
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            navigateSearchResults('prev');
                        } else {
                            navigateSearchResults('next');
                        }
                    } else if (e.key === 'Escape') {
                        closeModalWithAnimation();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateSearchResults('prev');
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateSearchResults('next');
                    }
                });
            }
            
            // Navigation buttons
            if (prevResult && nextResult) {
                prevResult.addEventListener('click', () => navigateSearchResults('prev'));
                nextResult.addEventListener('click', () => navigateSearchResults('next'));
            }
        });

        // Update search count display
        function updateSearchCount() {
            const searchCount = document.getElementById('searchCount');
            const prevResult = document.getElementById('prevResult');
            const nextResult = document.getElementById('nextResult');
            
            if (searchCount) {
                if (currentSearchResults.length === 0) {
                    searchCount.textContent = 'No results';
                    prevResult.disabled = true;
                    nextResult.disabled = true;
                } else {
                    searchCount.textContent = `${currentResultIndex + 1} of ${currentSearchResults.length}`;
                    prevResult.disabled = false;
                    nextResult.disabled = false;
                }
            }
        }
    </script>
</body>
</html>